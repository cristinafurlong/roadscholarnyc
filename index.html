<html>
<head>
	<title>Collision Incidents and School-related programs in Queens</title>
	<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
	<script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
	<!--[if lte IE 8]>
		<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.ie.css" />
	<![endif]-->
	<style>
		html, body {width:100%; height:100%; padding: 0; margin: 0;}
		#map { width: 100%; height:100%; background: black;}
	</style>
</head>

<body>
	<div id='map'></div>
	<script>
			var map = new L.Map('map', { 
				center: [40.7371782,-73.858452],
				zoom: 12
			});

			// add baselayer
			L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
			}).addTo(map);
										
			// temporary -- school is under jue's account currently, needs to be moved to cris's account
			var schools = {
				user_name: 'jue',
				type: 'cartodb',
				sublayers: [{
						sql: 'SELECT * FROM school_clean_geo_merge WHERE boronum = 4', // select schools in Queens
						cartocss: '#school_clean_geo_merge {marker-fill: #5770BB; marker-width:7;}',
						interactivity: 'school_name, total_enrollment'
				}]
			};

			var programs = {
				user_name:'cristina-furlong',
				type: 'cartodb',
				sublayers:[
					// UPK
					{
						sql: 'SELECT * FROM soj_universal_pre_',
						cartocss: '#soj_universal_pre_ {marker-fill: #000; marker-width:7; marker-line-width:0;}',
						interactivity: 'locname, seats'
					},
					// after school
					{
						sql: 'SELECT * FROM soj_dycd_after_school_programs_csv',
						cartocss: '#soj_dycd_after_school_programs_csv {marker-fill: #ff0; marker-width:7; marker-line-width:0;}',
						interactivity: 'agency,program'
					},
					// collision
					{
						sql: 'SELECT * FROM soj_nypd_motor_vehicle_collisions_4',
						cartocss: '#soj_nypd_motor_vehicle_collisions_4 {marker-fill: #f00; marker-width:7; marker-line-width:0;}',
						interactivity: 'contributing_factor_vehicle_1, vehicle_type_code_1, date'
					},
					// precinct
					// {
					// 	sql: 'SELECT * FROM soj_nypp WHERE precinct >= 100 AND precinct <=115', // select precincts in Queens http://www.nyc.gov/html/nypd/html/home/precincts.shtml
					// 	sql: 'SELECT * FROM soj_nypp',
					// 	cartocss: '#soj_nypp {polygon-fill: #000; polygon-fill-opacity:0.2;}'
					// }
				]
			}


			cartodb.createLayer(map, schools)
				.addTo(map)
				.on('done', function(layer) {
					// detour to add infowindow, no better way?
					// http://bl.ocks.org/xavijam/9269220
					cdb.vis.Vis.addInfowindow(map, layer.getSubLayer(0), ['school_name','total_enrollment']);
				}).on('error', function(error) {
					console.error(error)
				});

			cartodb.createLayer(map,programs)
				.addTo(map)
				.on('done', function(layer){
					cdb.vis.Vis.addInfowindow(map, layer.getSubLayer(0), ['locname','seats']);
					cdb.vis.Vis.addInfowindow(map, layer.getSubLayer(1), ['agency','program']);
					cdb.vis.Vis.addInfowindow(map, layer.getSubLayer(2), ['contributing_factor_vehicle_1','vehicle_type_code_1','date']);
				});
	</script>
</body>
</html>
